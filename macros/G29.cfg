[gcode_macro G29]
variable_k:1
gcode:
    M141 S0
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0
    {% if "xy" not in printer.toolhead.homed_axes %}
        G28 Y                               # Home Y axis
        G0 Y20 F1200                        # Move Y axis away from Y end-stop
        G28 X                               # Home X axis
    {% endif %}
    M109 S145                               # Set nozzle to 145 so any remaining filament stuck to nozzle is softened
    G28 Z                                   # Home Z
    Z_TILT_ADJUST                           # Ensure bed is level
    G28 Z                                   # Re-home Z again now that the bed is level
    M109 S0                                 # Turn off hotend
    BED_MESH_CALIBRATE RUNS=2 PROFILE=adaptive
    BED_MESH_PROFILE LOAD=adaptive
    SAVE_VARIABLE VARIABLE=profile_name VALUE='"adaptive"'
    CARTOGRAPHER_TOUCH FUZZY=10 RETRIES=10